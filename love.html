<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestra Aventura</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel para compilar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIREBASE (Versi√≥n Compat para HTML simple) -->
    <!-- App, Firestore y AUTH a√±adidos -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Merriweather:ital,wght@0,300;0,700;1,300&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; }
        .font-serif { font-family: 'Merriweather', serif; }
        .font-handwriting { font-family: 'Dancing Script', cursive; }
        
        @keyframes moveBackground {
            from { background-position: 0 0; }
            to { background-position: 500px 500px; }
        }
        .animated-bg { animation: moveBackground 60s linear infinite; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Loading Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d97706;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ---------------------------------------------------------
        // 1. CONFIGURACI√ìN DE FIREBASE (Tus datos reales)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDw7G4QZ-C0HRCiHtNb5yLlwOKEp-u67yM",
            authDomain: "loveofmylife-f95d1.firebaseapp.com",
            projectId: "loveofmylife-f95d1",
            storageBucket: "loveofmylife-f95d1.firebasestorage.app",
            messagingSenderId: "633055955478",
            appId: "1:633055955478:web:c0236f52f3c9e66de88337",
            measurementId: "G-XH18LY3JET"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth(); // Inicializamos Auth
        const DOC_ID = "adventureBookData";

        const { useState, useEffect } = React;

        // --- ICONOS SVG ---
        const Icon = ({ path, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{path}</svg>
        );

        const Icons = {
            Play: (props) => <Icon path={<polygon points="5 3 19 12 5 21 5 3"></polygon>} {...props} />,
            Pause: (props) => <Icon path={<><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>} {...props} />,
            SkipBack: (props) => <Icon path={<><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></>} {...props} />,
            SkipForward: (props) => <Icon path={<><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></>} {...props} />,
            Heart: (props) => <Icon path={<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>} {...props} />,
            X: (props) => <Icon path={<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>} {...props} />,
            Camera: (props) => <Icon path={<><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></>} {...props} />,
            Music: (props) => <Icon path={<path d="M9 18V5l12-2v13"></path>} {...props} />, 
            BookOpen: (props) => <Icon path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></>} {...props} />,
            Edit3: (props) => <Icon path={<><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></>} {...props} />,
            Trash2: (props) => <Icon path={<><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></>} {...props} />,
            ChevronLeft: (props) => <Icon path={<polyline points="15 18 9 12 15 6"></polyline>} {...props} />,
            ChevronRight: (props) => <Icon path={<polyline points="9 18 15 12 9 6"></polyline>} {...props} />,
            Globe: (props) => <Icon path={<><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"></path></>} {...props} />,
            ArrowLeft: (props) => <Icon path={<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>} {...props} />,
            Mail: (props) => <Icon path={<><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></>} {...props} />,
            Clock: (props) => <Icon path={<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>} {...props} />,
            Ticket: (props) => <Icon path={<><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"></path></>} {...props} />,
            Youtube: (props) => <Icon path={<path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path>} {...props} />,
            PlayCircle: (props) => <Icon path={<><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></>} {...props} />,
            ImageIcon: (props) => <Icon path={<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>} {...props} />,
            Save: (props) => <Icon path={<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8"></path>} {...props} />,
            User: (props) => <Icon path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></>} {...props} />,
            LogOut: (props) => <Icon path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></>} {...props} />
        };

        // --- UTILIDADES ---
        const convertToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        // --- COMPONENTES ---

        const FloatingBackground = () => {
          const icons = ["üç¨", "üêõ", "üç´", "ü•ê", "üç∞", "üç™", "üçù", "ü•©", "üçè", "‚òï", "üçî", "üßã", "ü•£", "üçÆ", "üü†"];
          return (
            <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden opacity-30">
              {icons.map((icon, index) => (
                <div key={index} className="absolute text-4xl animate-pulse"
                  style={{ top: `${Math.random() * 100}%`, left: `${Math.random() * 100}%`, transform: `rotate(${Math.random() * 360}deg)`, animationDuration: `${3 + Math.random() * 5}s`, fontSize: `${20 + Math.random() * 40}px` }}>
                  {icon}
                </div>
              ))}
            </div>
          );
        };

        const MainWrapper = ({ children, backgroundImage }) => (
          <div className={`min-h-screen flex flex-col items-center justify-center relative overflow-x-hidden font-sans transition-colors duration-500 ${backgroundImage ? 'animated-bg' : ''}`}
              style={{
                  backgroundImage: backgroundImage ? `url(${backgroundImage})` : 'linear-gradient(to bottom right, #e0f7fa, #e8f5e9, #fff3e0)',
                  backgroundSize: backgroundImage ? '400px' : 'cover', backgroundRepeat: backgroundImage ? 'repeat' : 'no-repeat', backgroundColor: '#e8f5e9'
              }}>
              {backgroundImage && <div className="absolute inset-0 bg-white/40 pointer-events-none fixed"></div>}
              <FloatingBackground />
              {children}
          </div>
        );

        const PlatformSelector = ({ isOpen, onClose, links }) => {
          if (!isOpen) return null;
          const hasLinks = links.spotifyUrl || links.youtubeUrl || links.youtubeMusicUrl;
          return (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 relative transform scale-100 transition-transform">
                <button onClick={onClose} className="absolute top-2 right-2 text-slate-400 hover:text-slate-600 p-1 bg-slate-100 rounded-full"><Icons.X className="w-5 h-5" /></button>
                <h3 className="text-lg font-bold text-center text-slate-800 mb-6">Escuchar en...</h3>
                {!hasLinks ? <p className="text-center text-slate-500 text-sm">No hay enlaces configurados.</p> : (
                  <div className="space-y-3">
                    {links.spotifyUrl && <a href={links.spotifyUrl} target="_blank" className="flex items-center gap-4 w-full p-3 rounded-xl bg-[#1DB954] text-white font-bold hover:shadow-lg transition-all"><Icons.Music className="w-6 h-6" /> Spotify</a>}
                    {links.youtubeUrl && <a href={links.youtubeUrl} target="_blank" className="flex items-center gap-4 w-full p-3 rounded-xl bg-[#FF0000] text-white font-bold hover:shadow-lg transition-all"><Icons.Youtube className="w-6 h-6" /> YouTube</a>}
                    {links.youtubeMusicUrl && <a href={links.youtubeMusicUrl} target="_blank" className="flex items-center gap-4 w-full p-3 rounded-xl bg-[#202020] text-white font-bold hover:shadow-lg transition-all"><Icons.PlayCircle className="w-6 h-6 text-red-500" /> YT Music</a>}
                  </div>
                )}
              </div>
            </div>
          );
        };

        const SpotifyPlaque = ({ songData, isPlaying, setIsPlaying }) => {
          const [showPlatforms, setShowPlatforms] = useState(false);
          return (
            <>
              <div className="relative z-10 w-full max-w-sm mx-auto mb-8 transition-all duration-500">
                <div className="bg-white/40 backdrop-blur-md border border-white/60 shadow-xl rounded-xl p-6 text-slate-900 transition-transform duration-500 hover:scale-[1.02]">
                  <div className="relative aspect-square w-full bg-slate-200 rounded-lg overflow-hidden shadow-lg mb-6 group">
                    <img src={songData.coverUrl || "https://via.placeholder.com/400"} alt="Album Cover" className={`w-full h-full object-cover transition-transform duration-700 ${isPlaying ? 'scale-110' : 'scale-100'}`} />
                  </div>
                  <div className="flex justify-between items-end mb-4">
                    <div className="overflow-hidden">
                      <h2 className="text-2xl font-bold leading-tight text-slate-900 drop-shadow-sm font-sans truncate">{songData.title}</h2>
                      <p className="text-slate-800 font-medium text-lg mt-1 opacity-90 truncate">{songData.artist}</p>
                    </div>
                    <Icons.Heart className={`w-7 h-7 cursor-pointer transition-colors duration-300 shrink-0 ml-2 ${isPlaying ? 'fill-green-600 text-green-600' : 'text-slate-700 hover:text-green-600'}`} />
                  </div>
                  <div className="w-full bg-slate-500/30 h-1.5 rounded-full mb-2 overflow-hidden">
                    <div className={`h-full bg-slate-900 rounded-full ${isPlaying ? 'animate-[width_3s_ease-in-out_infinite_alternate]' : 'w-1/3'}`} style={{ width: isPlaying ? 'auto' : '30%' }}></div>
                  </div>
                  <div className="flex justify-between text-xs font-semibold text-slate-800 mb-6"><span>0:24</span><span>{songData.duration}</span></div>
                  <div className="flex justify-between items-center px-2">
                    <Icons.SkipBack className="w-8 h-8 cursor-pointer" />
                    <button onClick={() => {setIsPlaying(!isPlaying); if(!isPlaying) setShowPlatforms(true);}} className="w-16 h-16 bg-slate-900 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-black hover:scale-105 transition-all">
                      {isPlaying ? <Icons.Pause className="w-7 h-7 fill-current" /> : <Icons.Play className="w-7 h-7 fill-current ml-1" />}
                    </button>
                    <Icons.SkipForward className="w-8 h-8 cursor-pointer" />
                  </div>
                </div>
              </div>
              <PlatformSelector isOpen={showPlatforms} onClose={() => setShowPlatforms(false)} links={songData} />
            </>
          );
        };

        const AdventureBook = ({ pages, currentPage, onPageChange, onOpenAlbum }) => {
          const activePage = pages && pages.length > 0 ? pages[currentPage] : { title: "Fin", body: "..." };
          const isLastPage = currentPage === pages.length - 1;

          return (
            <div className="relative z-10 max-w-4xl mx-auto px-2 md:px-0 perspective-1000 mb-20">
              <div className="bg-[#5D4037] p-1.5 md:p-3 rounded-[10px] md:rounded-[16px] shadow-2xl relative transition-all duration-500">
                  <div className="bg-[#fcf5e5] rounded flex shadow-inner overflow-hidden min-h-[550px] md:min-h-[500px] relative">
                     <div className="hidden md:flex w-1/2 border-r border-[#d4c5a9] flex-col items-center justify-center p-8 relative">
                        <div className="bg-white p-3 shadow-lg border border-gray-200 w-64 h-72 flex flex-col items-center justify-between rotate-[-3deg]">
                           <div className={`w-full h-56 rounded-sm overflow-hidden relative border border-gray-100 ${!activePage.imageUrl ? 'bg-yellow-100' : 'bg-slate-100'}`}>
                               {activePage.imageUrl ? <img src={activePage.imageUrl} className="w-full h-full object-cover sepia-[.3]" /> : <div className="absolute inset-0 flex flex-col items-center justify-center p-4 text-center border-4 border-double border-yellow-800/20 m-2"><Icons.Globe className="w-16 h-16 text-yellow-800/40 mb-2" /><span className="font-serif font-bold text-2xl text-yellow-900">Our<br/>Adventure<br/>Book</span></div>}
                           </div>
                           <div className="text-center font-handwriting text-gray-600 text-xl mt-2">{activePage.imageUrl ? "Un recuerdo..." : "Para siempre"}</div>
                        </div>
                     </div>
                     <div className="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-between relative bg-[#fcf5e5]">
                        <div className="flex-grow relative z-10">
                           <h3 className="text-3xl font-bold text-yellow-900 mb-6 font-serif border-b-2 border-yellow-900/10 pb-3 flex items-center gap-2">
                             <span className="text-xl opacity-50">‚ú®</span> {activePage.title}
                           </h3>
                           <div className="prose prose-stone font-serif text-slate-800 leading-relaxed whitespace-pre-wrap text-lg italic">{activePage.body}</div>
                           {isLastPage && <div className="mt-8 text-center animate-bounce"><button onClick={onOpenAlbum} className="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2 mx-auto relative z-20"><Icons.Camera className="w-5 h-5" /> Ver Nuestro √Ålbum</button></div>}
                        </div>
                        <div className="flex justify-between items-center mt-8 border-t-2 border-dotted border-yellow-900/20 pt-4 relative z-10">
                            <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 0} className="text-yellow-800 disabled:opacity-30 hover:bg-yellow-900/10 rounded-full p-2"><Icons.ChevronLeft className="w-6 h-6" /></button>
                            <span className="text-sm text-yellow-800/60 font-serif italic font-bold">P√°gina {currentPage + 1} de {pages.length}</span>
                            <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === pages.length - 1} className="text-yellow-800 disabled:opacity-30 hover:bg-yellow-900/10 rounded-full p-2"><Icons.ChevronRight className="w-6 h-6" /></button>
                        </div>
                     </div>
                  </div>
              </div>
            </div>
          );
        };

        const PhotoAlbum = ({ photos, onBack }) => (
          <div className="min-h-screen bg-transparent p-4 pt-12 animate-in fade-in zoom-in duration-500">
            <div className="container mx-auto max-w-5xl relative z-10">
              <button onClick={onBack} className="mb-8 bg-white/90 backdrop-blur text-slate-800 px-6 py-3 rounded-full font-bold shadow-lg hover:bg-white flex items-center gap-2 transition-all"><Icons.ArrowLeft className="w-5 h-5" /> Volver al Libro</button>
              <h1 className="text-4xl font-serif text-center text-green-900 bg-white/50 backdrop-blur-sm p-4 rounded-xl mb-12 drop-shadow-sm inline-block w-full">üì∏ Nuestro √Ålbum de Recuerdos</h1>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {photos.map((photo, index) => {
                    const imgSrc = typeof photo === 'string' ? photo : photo.url;
                    const caption = typeof photo === 'string' ? `Recuerdo #${index + 1}` : (photo.caption || `Recuerdo #${index + 1}`);
                    
                    return (
                        <div key={index} className="bg-white p-3 rounded-lg shadow-lg transform hover:scale-[1.02] transition-all rotate-1 hover:rotate-0">
                          <div className="aspect-[4/5] bg-slate-100 rounded overflow-hidden mb-2"><img src={imgSrc} className="w-full h-full object-cover" /></div>
                          <div className="text-center font-handwriting text-gray-700 text-lg py-2 break-words leading-tight">{caption}</div>
                        </div>
                    );
                  })}
              </div>
            </div>
          </div>
        );

        const RelationshipCounter = ({ startDate }) => {
          const [time, setTime] = useState({ years: 0, months: 0, days: 0 });
          useEffect(() => {
            const calculateTime = () => {
              const start = new Date(startDate);
              const now = new Date();
              if (isNaN(start.getTime())) return;
              let years = now.getFullYear() - start.getFullYear();
              let months = now.getMonth() - start.getMonth();
              let days = now.getDate() - start.getDate();
              if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
              if (months < 0) { years--; months += 12; }
              setTime({ years, months, days });
            };
            calculateTime();
            const interval = setInterval(calculateTime, 1000 * 60 * 60);
            return () => clearInterval(interval);
          }, [startDate]);

          return (
            <div className="bg-white/90 backdrop-blur-md rounded-2xl p-6 border border-slate-200 shadow-xl inline-block">
                <div className="flex items-center justify-center gap-8 text-green-900">
                    <div className="text-center"><span className="block text-4xl font-bold">{time.years}</span><span className="text-xs uppercase font-bold opacity-60">A√±os</span></div>
                    <div className="text-center border-l border-slate-300 pl-8"><span className="block text-4xl font-bold">{time.months}</span><span className="text-xs uppercase font-bold opacity-60">Meses</span></div>
                    <div className="text-center border-l border-slate-300 pl-8"><span className="block text-4xl font-bold">{time.days}</span><span className="text-xs uppercase font-bold opacity-60">D√≠as</span></div>
                </div>
                <div className="text-center mt-4 text-xs font-bold text-slate-500 flex items-center justify-center gap-1 uppercase tracking-wide"><Icons.Clock className="w-3 h-3" /> De aventuras juntos</div>
            </div>
          );
        };

        const EnvelopesView = ({ envelopes, onBack }) => {
          const [selectedEnvelope, setSelectedEnvelope] = useState(null);
          return (
            <div className="min-h-screen bg-transparent p-4 pt-12 relative overflow-y-auto">
              <div className="container mx-auto max-w-4xl relative z-10">
                <button onClick={onBack} className="mb-8 bg-white/90 backdrop-blur text-slate-800 px-6 py-3 rounded-full font-bold shadow-lg hover:bg-white flex items-center gap-2"><Icons.ArrowLeft className="w-5 h-5" /> Volver</button>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {envelopes.map((env) => (
                    <button key={env.id} onClick={() => setSelectedEnvelope(env)} className="bg-white p-6 rounded-lg shadow-md border-2 border-amber-100 flex flex-col items-center gap-4 group">
                      <div className="w-full h-32 bg-amber-50 rounded border-2 border-dashed border-amber-200 flex items-center justify-center group-hover:bg-amber-100 transition-colors relative overflow-hidden">
                         <div className="absolute inset-0 flex items-center justify-center"><Icons.Mail className="w-16 h-16 text-amber-300 group-hover:scale-110 transition-transform" /></div>
                         <div className="absolute bottom-2 right-2 w-8 h-8 bg-red-700 rounded-full opacity-80 shadow-inner flex items-center justify-center text-[10px] text-white font-serif">Love</div>
                      </div>
                      <span className="font-bold text-amber-900 text-lg text-center font-serif">"Abrir cuando {env.title}"</span>
                    </button>
                  ))}
                </div>
                {selectedEnvelope && (
                  <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-[#fff9e6] w-full max-w-lg rounded-sm p-8 shadow-2xl relative border-8 border-white transform rotate-1">
                      <button onClick={() => setSelectedEnvelope(null)} className="absolute top-2 right-2 text-amber-900"><Icons.X className="w-8 h-8" /></button>
                      <h3 className="text-2xl font-serif font-bold text-amber-900 mb-6 border-b-2 border-amber-900/10 pb-4 text-center">...{selectedEnvelope.title}</h3>
                      <div className="prose prose-amber text-lg leading-relaxed font-serif whitespace-pre-wrap text-slate-700 max-h-[60vh] overflow-y-auto custom-scrollbar">{selectedEnvelope.content}</div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        const CouponsView = ({ coupons, onBack }) => {
          return (
            <div className="min-h-screen bg-transparent p-4 pt-12 relative overflow-y-auto">
              <div className="container mx-auto max-w-4xl relative z-10">
                <button onClick={onBack} className="mb-8 bg-white/90 backdrop-blur text-pink-800 px-6 py-3 rounded-full font-bold shadow-lg hover:bg-white flex items-center gap-2"><Icons.ArrowLeft className="w-5 h-5" /> Volver</button>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                  {coupons.map((coupon) => (
                    <div key={coupon.id} className="relative bg-white rounded-lg shadow-md border-2 border-pink-200 flex flex-col items-center p-8 text-center cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all">
                       <h3 className="text-2xl font-bold text-pink-800 font-serif mb-2">{coupon.title}</h3>
                       <p className="text-pink-600/60 text-sm font-bold uppercase tracking-widest">V√ÅLIDO POR UN USO</p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        // --- COMPONENTE PRINCIPAL APP ---
        const App = () => {
          const [view, setView] = useState('intro');
          const [isPlaying, setIsPlaying] = useState(false);
          const [showAdmin, setShowAdmin] = useState(false);
          const [showPasswordModal, setShowPasswordModal] = useState(false);
          const [currentPage, setCurrentPage] = useState(0);
          const [loading, setLoading] = useState(true);
          const [saving, setSaving] = useState(false);
          
          // Estados para login
          const [user, setUser] = useState(null);
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');

          // Datos iniciales
          const defaultData = {
            startDate: "2023-01-01",
            backgroundImage: "",
            intro: { title: "Para el amor de mi vida", subtitle: "\"Cada p√°gina es una nueva aventura a tu lado...\"", buttonText: "Comenzar Aventura" },
            pages: [
              { title: "Bienvenida", body: "Este es el comienzo...", imageUrl: "", song: { title: "Canci√≥n", artist: "Artista", duration: "3:35", coverUrl: "" } }
            ],
            albumPhotos: [], // Ahora ser√° un array de objetos { url: "...", caption: "..." }
            envelopes: [{ id: 1, title: "est√©s triste", content: "Te amo mucho." }],
            coupons: [{ id: 1, title: "Vale por un Beso" }]
          };

          const [data, setData] = useState(defaultData);

          // ESCUCHA SI EL USUARIO EST√Å LOGUEADO
          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged((currentUser) => {
              setUser(currentUser);
              if (currentUser) {
                  setShowPasswordModal(false);
                  // Opcional: abrir admin autom√°ticamente si se loguea
                  // setShowAdmin(true);
              }
            });
            return () => unsubscribe();
          }, []);

          // CARGAR DATOS
          useEffect(() => {
            const fetchData = async () => {
                try {
                    const doc = await db.collection("adventure_books").doc(DOC_ID).get();
                    if (doc.exists) {
                        setData(doc.data());
                    } else {
                        await db.collection("adventure_books").doc(DOC_ID).set(defaultData);
                    }
                } catch (error) {
                    console.error("Error cargando:", error);
                    // No alertamos en pantalla de carga para no molestar a usuarios si es un error menor
                } finally {
                    setLoading(false);
                }
            };
            fetchData();
          }, []);

          // GUARDAR DATOS (Solo si user existe)
          const saveDataToFirebase = async () => {
              if (!user) {
                  alert("Debes estar logueado para guardar cambios.");
                  return;
              }
              setSaving(true);
              try {
                  await db.collection("adventure_books").doc(DOC_ID).set(data);
                  alert("¬°Cambios guardados en la nube con √©xito!");
                  setShowAdmin(false);
              } catch (error) {
                  console.error("Error guardando:", error);
                  alert("Error al guardar. Verifica que est√©s logueado y tengas permisos: " + error.message);
              } finally {
                  setSaving(false);
              }
          };

          // LOGIN
          const handleLogin = async (e) => {
              e.preventDefault();
              try {
                  await auth.signInWithEmailAndPassword(email, password);
                  setShowAdmin(true);
              } catch (error) {
                  alert("Error al entrar: " + error.message);
              }
          };

          const handleLogout = () => {
              auth.signOut();
              setShowAdmin(false);
          };

          // Handlers de archivos
          const handleFileUpload = async (e, callback) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 500000) {
                    alert("La imagen es muy grande (Max 500KB).");
                }
                try {
                    const base64 = await convertToBase64(file);
                    callback(base64);
                } catch (err) {
                    console.error(err);
                }
            }
          };
          
          const handleIntroChange = (e) => setData(prev => ({ ...prev, intro: { ...prev.intro, [e.target.name]: e.target.value } }));
          const handlePageChange = (index, field, value, nestedField = null) => {
            const newPages = [...data.pages];
            if (nestedField) newPages[index][field][nestedField] = value;
            else newPages[index][field] = value;
            setData(prev => ({ ...prev, pages: newPages }));
          };
          const addPage = () => setData(prev => ({ ...prev, pages: [...prev.pages, { title: "Nuevo", body: "...", imageUrl: "", song: { title: "Canci√≥n", artist: "Artista", duration: "3:00", coverUrl: "" } }] }));
          const removePage = (index) => {
              const newPages = data.pages.filter((_, i) => i !== index);
              setData(prev => ({ ...prev, pages: newPages }));
              if (currentPage >= newPages.length) setCurrentPage(newPages.length - 1);
          };
          const addAlbumPhoto = (url) => setData(prev => ({ ...prev, albumPhotos: [...prev.albumPhotos, { url, caption: "" }] }));
          
          const handleAlbumCaptionChange = (index, value) => {
            const newPhotos = [...data.albumPhotos];
            // Asegurar que sea objeto si era string (migraci√≥n al vuelo)
            if (typeof newPhotos[index] === 'string') {
                newPhotos[index] = { url: newPhotos[index], caption: value };
            } else {
                newPhotos[index].caption = value;
            }
            setData(prev => ({ ...prev, albumPhotos: newPhotos }));
          };

          const removeAlbumPhoto = (index) => setData(prev => ({ ...prev, albumPhotos: prev.albumPhotos.filter((_, i) => i !== index) }));
          const updateEnvelope = (id, field, value) => setData(prev => ({ ...prev, envelopes: prev.envelopes.map(env => env.id === id ? { ...env, [field]: value } : env) }));
          const addEnvelope = () => setData(prev => ({ ...prev, envelopes: [...prev.envelopes, { id: Date.now(), title: "...", content: "..." }] }));
          const removeEnvelope = (id) => setData(prev => ({ ...prev, envelopes: prev.envelopes.filter(env => env.id !== id) }));
          const updateCoupon = (id, title) => setData(prev => ({ ...prev, coupons: prev.coupons.map(c => c.id === id ? { ...c, title } : c) }));
          const addCoupon = () => setData(prev => ({ ...prev, coupons: [...prev.coupons, { id: Date.now(), title: "Nuevo Vale" }] }));
          const removeCoupon = (id) => setData(prev => ({ ...prev, coupons: prev.coupons.filter(c => c.id !== id) }));

          const currentSong = data.pages[currentPage]?.song || { title: "...", artist: "...", duration: "--:--", coverUrl: "" };

          if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-[#fcf5e5]"><div className="loader mb-4"></div><p className="text-stone-600 font-serif">Cargando nuestra historia...</p></div>;

          if (view === 'album') return <MainWrapper backgroundImage={data.backgroundImage}><PhotoAlbum photos={data.albumPhotos} onBack={() => setView('main')} /></MainWrapper>;
          if (view === 'envelopes') return <MainWrapper backgroundImage={data.backgroundImage}><EnvelopesView envelopes={data.envelopes} onBack={() => setView('intro')} /></MainWrapper>;
          if (view === 'coupons') return <MainWrapper backgroundImage={data.backgroundImage}><CouponsView coupons={data.coupons} onBack={() => setView('intro')} /></MainWrapper>;

          if (view === 'intro') {
            return (
              <MainWrapper backgroundImage={data.backgroundImage}>
                <div className="z-10 w-full max-w-4xl p-6 flex flex-col items-center">
                  <div className="text-center mb-12 animate-in slide-in-from-bottom-10 fade-in duration-1000">
                     <h1 className="text-6xl md:text-8xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-800 to-teal-800 drop-shadow-sm font-serif">{data.intro.title}</h1>
                     <div className="w-32 h-1.5 bg-yellow-400 mx-auto mt-4 rounded-full"></div>
                     <p className="text-xl md:text-2xl text-slate-800 mt-6 font-medium italic max-w-xl mx-auto leading-relaxed bg-white/40 p-2 rounded-lg backdrop-blur-sm">{data.intro.subtitle}</p>
                  </div>
                  <div className="mb-12"><RelationshipCounter startDate={data.startDate} /></div>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full animate-in zoom-in fade-in duration-1000 delay-300">
                      <button onClick={() => setView('main')} className="md:col-span-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 rounded-2xl shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all group flex items-center justify-center gap-4 relative overflow-hidden">
                        <div className="bg-white/20 p-3 rounded-full"><Icons.BookOpen className="w-8 h-8 fill-current" /></div>
                        <div className="text-left"><span className="block text-xs uppercase tracking-widest opacity-80 font-bold">El Regalo Principal</span><span className="block text-2xl font-bold font-serif">{data.intro.buttonText}</span></div>
                      </button>
                      <button onClick={() => setView('envelopes')} className="bg-white/90 p-6 rounded-2xl shadow-lg border-2 border-amber-100 flex flex-col items-center gap-3 backdrop-blur-sm hover:scale-105 transition"><div className="w-14 h-14 bg-amber-100 rounded-full flex items-center justify-center text-amber-600"><Icons.Mail className="w-7 h-7" /></div><span className="font-bold text-slate-700 text-lg">Cartas Especiales</span></button>
                      <button onClick={() => setView('coupons')} className="bg-white/90 p-6 rounded-2xl shadow-lg border-2 border-pink-100 flex flex-col items-center gap-3 backdrop-blur-sm hover:scale-105 transition"><div className="w-14 h-14 bg-pink-100 rounded-full flex items-center justify-center text-pink-600"><Icons.Ticket className="w-7 h-7" /></div><span className="font-bold text-slate-700 text-lg">Cuponera de Amor</span></button>
                  </div>
                </div>
                
                {/* BOT√ìN PING√úINO (Si est√° logueado abre admin, si no abre login) */}
                <button 
                    onClick={() => user ? setShowAdmin(true) : setShowPasswordModal(true)} 
                    className={`fixed bottom-6 left-6 z-50 p-3 backdrop-blur-md rounded-full shadow-lg hover:scale-110 transition-all text-2xl ${user ? 'bg-green-100 grayscale-0 border-2 border-green-500' : 'bg-white/80 grayscale hover:grayscale-0'}`}
                    title={user ? "Abrir Admin" : "Modo Creador"}
                >
                    üêß
                </button>
                
                {/* MODAL LOGIN */}
                {showPasswordModal && !user && (
                  <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                     <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
                        <h3 className="text-lg font-bold text-slate-800 mb-6">Modo Creador</h3>
                        <form onSubmit={handleLogin} className="flex flex-col gap-3">
                            <input 
                                type="email" 
                                value={email} 
                                onChange={(e) => setEmail(e.target.value)} 
                                placeholder="Email admin..." 
                                className="w-full border rounded-lg p-3 text-lg" 
                                required
                            />
                            <input 
                                type="password" 
                                value={password} 
                                onChange={(e) => setPassword(e.target.value)} 
                                placeholder="Contrase√±a..." 
                                className="w-full border rounded-lg p-3 text-lg"
                                required 
                            />
                            <div className="flex gap-2 mt-2">
                                <button type="button" onClick={() => {setShowPasswordModal(false);}} className="flex-1 bg-slate-200 py-2 rounded-lg font-bold text-slate-700">Cancelar</button>
                                <button type="submit" className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700">Entrar</button>
                            </div>
                        </form>
                     </div>
                  </div>
                )}

                {/* PANEL ADMIN (SOLO VISIBLE SI USER EXISTE) */}
                {showAdmin && user && (
                  <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                      <div className="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 rounded-t-2xl">
                          <h3 className="font-bold flex items-center gap-2"><Icons.Edit3 className="w-5 h-5" /> Admin Panel</h3>
                          <div className="flex items-center gap-2">
                              <span className="text-xs opacity-60 hidden sm:inline">{user.email}</span>
                              <button onClick={() => setShowAdmin(false)}><Icons.X className="w-6 h-6" /></button>
                          </div>
                      </div>
                      
                      <div className="bg-yellow-100 p-2 text-center text-xs text-yellow-800 font-bold border-b border-yellow-200">
                         ‚ö†Ô∏è Recuerda dar clic en "Guardar Cambios" abajo para subir todo a la nube.
                      </div>

                      <div className="p-6 space-y-8 overflow-y-auto custom-scrollbar text-slate-800">
                        <section className="space-y-4 border-b pb-6">
                            <h4 className="font-bold text-green-800">General</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="title" value={data.intro.title} onChange={handleIntroChange} className="border p-2 rounded" placeholder="T√≠tulo" />
                                <input type="date" value={data.startDate} onChange={(e) => setData({...data, startDate: e.target.value})} className="border p-2 rounded" />
                                <textarea name="subtitle" rows={2} value={data.intro.subtitle} onChange={handleIntroChange} className="w-full border p-2 rounded md:col-span-2" placeholder="Subt√≠tulo"></textarea>
                                <div className="md:col-span-2 bg-blue-50 p-3 rounded flex justify-between items-center">
                                    <span className="text-xs font-bold text-blue-800">Fondo de Pantalla</span>
                                    <label className="bg-blue-600 text-white px-3 py-2 rounded text-sm font-bold cursor-pointer"><Icons.ImageIcon className="w-4 h-4 inline mr-2" /> Subir Img <input type="file" accept="image/*" onChange={(e) => handleFileUpload(e, (url) => setData({...data, backgroundImage: url}))} className="hidden" /></label>
                                </div>
                            </div>
                        </section>
                        <section className="space-y-4 border-b pb-6">
                            <div className="flex justify-between"><h4>Sobres</h4><button onClick={addEnvelope} className="bg-amber-500 text-white px-2 rounded text-sm">+ Nuevo</button></div>
                            <div className="grid grid-cols-1 gap-2">{data.envelopes.map(env => (
                                <div key={env.id} className="border p-2 rounded flex flex-col gap-2 relative">
                                    <button onClick={() => removeEnvelope(env.id)} className="absolute top-2 right-2 text-red-500"><Icons.Trash2 className="w-4 h-4" /></button>
                                    <input value={env.title} onChange={(e) => updateEnvelope(env.id, 'title', e.target.value)} className="border p-1 text-sm" placeholder="Cu√°ndo abrir..." />
                                    <textarea value={env.content} onChange={(e) => updateEnvelope(env.id, 'content', e.target.value)} className="border p-1 text-sm" placeholder="Contenido..." />
                                </div>
                            ))}</div>
                        </section>
                        <section className="space-y-4 border-b pb-6">
                            <div className="flex justify-between"><h4>Cupones</h4><button onClick={addCoupon} className="bg-pink-500 text-white px-2 rounded text-sm">+ Nuevo</button></div>
                            <div className="grid grid-cols-2 gap-2">{data.coupons.map(c => (
                                <div key={c.id} className="border p-2 rounded flex items-center gap-2">
                                    <input value={c.title} onChange={(e) => updateCoupon(c.id, e.target.value)} className="border p-1 w-full text-sm" />
                                    <button onClick={() => removeCoupon(c.id)} className="text-red-500"><Icons.Trash2 className="w-4 h-4" /></button>
                                </div>
                            ))}</div>
                        </section>
                        <section className="space-y-4">
                             <div className="flex justify-between"><h4>Libro & M√∫sica</h4><button onClick={addPage} className="bg-green-600 text-white px-3 py-1 rounded text-sm">+ P√°gina</button></div>
                             {data.pages.map((page, index) => (
                                <div key={index} className="border p-4 rounded relative shadow-sm bg-gray-50">
                                    <button onClick={() => removePage(index)} className="absolute top-2 right-2 text-red-500"><Icons.Trash2 className="w-4 h-4" /></button>
                                    <span className="text-xs bg-gray-200 px-2 rounded font-bold">P√°gina {index + 1}</span>
                                    <div className="grid grid-cols-2 gap-4 mt-2">
                                        <div className="flex flex-col gap-2">
                                            <input value={page.title} onChange={(e) => handlePageChange(index, 'title', e.target.value)} className="border p-1 text-sm font-bold" placeholder="T√≠tulo Cap" />
                                            <textarea value={page.body} onChange={(e) => handlePageChange(index, 'body', e.target.value)} className="border p-1 text-sm h-20" placeholder="Texto..." />
                                        </div>
                                        <div className="flex flex-col gap-2 bg-white p-2 rounded border">
                                            <input value={page.song.title} onChange={(e) => handlePageChange(index, 'song', e.target.value, 'title')} className="border p-1 text-xs" placeholder="Canci√≥n" />
                                            <input value={page.song.artist} onChange={(e) => handlePageChange(index, 'song', e.target.value, 'artist')} className="border p-1 text-xs" placeholder="Artista" />
                                            <input value={page.song.spotifyUrl || ""} onChange={(e) => handlePageChange(index, 'song', e.target.value, 'spotifyUrl')} className="border p-1 text-[10px]" placeholder="Link Spotify" />
                                            <input value={page.song.youtubeUrl || ""} onChange={(e) => handlePageChange(index, 'song', e.target.value, 'youtubeUrl')} className="border p-1 text-[10px]" placeholder="Link YouTube" />
                                            <input value={page.song.youtubeMusicUrl || ""} onChange={(e) => handlePageChange(index, 'song', e.target.value, 'youtubeMusicUrl')} className="border p-1 text-[10px]" placeholder="Link YouTube Music" />
                                            <label className="cursor-pointer text-xs text-blue-600 border-t pt-1 font-bold block mt-1">üì∏ Foto P√°gina <input type="file" accept="image/*" onChange={(e) => handleFileUpload(e, (url) => handlePageChange(index, 'imageUrl', url))} className="hidden" /></label>
                                            <label className="cursor-pointer text-xs text-green-600 font-bold">üéµ Portada Canci√≥n <input type="file" accept="image/*" onChange={(e) => handleFileUpload(e, (url) => handlePageChange(index, 'song', url, 'coverUrl'))} className="hidden" /></label>
                                        </div>
                                    </div>
                                </div>
                             ))}
                        </section>
                        <section className="space-y-4 pt-4 border-t">
                           <div className="flex justify-between"><h4>√Ålbum Final</h4><label className="bg-yellow-600 text-white px-3 py-1 rounded text-sm cursor-pointer">+ Foto <input type="file" accept="image/*" onChange={(e) => handleFileUpload(e, addAlbumPhoto)} className="hidden" /></label></div>
                           <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                             {data.albumPhotos.map((p, i) => {
                               const url = typeof p === 'string' ? p : p.url;
                               const caption = typeof p === 'string' ? "" : p.caption;
                               return (
                                 <div key={i} className="relative group border p-2 rounded flex flex-col gap-2">
                                     <div className="relative h-24 w-full">
                                         <img src={url} className="w-full h-full object-cover rounded" />
                                         <button onClick={() => removeAlbumPhoto(i)} className="absolute inset-0 bg-black/50 text-white flex justify-center items-center opacity-0 group-hover:opacity-100"><Icons.Trash2 className="w-4 h-4" /></button>
                                     </div>
                                     <input 
                                       type="text" 
                                       value={caption} 
                                       onChange={(e) => handleAlbumCaptionChange(i, e.target.value)} 
                                       className="w-full border p-1 text-xs rounded" 
                                       placeholder="Descripci√≥n..." 
                                     />
                                 </div>
                               );
                             })}
                           </div>
                        </section>
                      </div>
                      <div className="p-4 border-t bg-gray-50 rounded-b-2xl flex gap-3">
                        <button onClick={handleLogout} className="bg-red-50 text-red-600 px-4 py-3 rounded-xl font-bold hover:bg-red-100 flex items-center gap-2"><Icons.LogOut className="w-5 h-5" /> Salir</button>
                        <button onClick={saveDataToFirebase} disabled={saving} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 flex justify-center items-center gap-2">
                             {saving ? "Guardando..." : <><Icons.Save className="w-5 h-5" /> GUARDAR CAMBIOS</>}
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </MainWrapper>
            );
          }

          return <MainWrapper backgroundImage={data.backgroundImage}><div className="container mx-auto px-4 py-8 relative z-10 pb-32"><header className="text-center mb-6 opacity-70"><button onClick={() => setView('intro')} className="inline-block px-4 py-1 bg-white/50 backdrop-blur rounded-full text-xs font-bold text-green-800 hover:bg-white cursor-pointer transition">üè† Ir al Inicio</button></header><SpotifyPlaque songData={currentSong} isPlaying={isPlaying} setIsPlaying={setIsPlaying} /><AdventureBook pages={data.pages} currentPage={currentPage} onPageChange={setCurrentPage} onOpenAlbum={() => setView('album')} /></div></MainWrapper>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>